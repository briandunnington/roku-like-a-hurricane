<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title>Component initialization order</title>

    <meta name="title" content="Component initialization order"/>
    <meta name="description" content="Understanding the component initialization order and some potential gotchas"/>
    <meta name="author" content="Brian Dunnington" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website"/>
    <meta property="og:site_name" content="Roku Like A Hurricane" />
    <meta property="og:url" content="https://rokulikeahurricane.io/"/>
    <meta property="og:title" content="Component initialization order"/>
    <meta property="og:description" content="Understanding the component initialization order and some potential gotchas"/>
    <meta property="article:published_time" content="2018-12-18T12:00:00"/>
    <meta property="og:image" content="https://rokulikeahurricane.io/img/roku_logo.png"/>
    <meta property="twitter:card" content="summary_large_image"/>
    <meta property="twitter:site" content="@briandunnington"/>
    <meta property="twitter:creator" content="@briandunnington"/>
    <meta property="twitter:url" content="https://rokulikeahurricane.io/"/>
    <meta property="twitter:title" content="Component initialization order"/>
    <meta property="twitter:description" content="Understanding the component initialization order and some potential gotchas"/>
    <meta property="twitter:image" content="https://rokulikeahurricane.io/img/roku_logo.png"/>

    <link rel="canonical" href="https://rokulikeahurricane.io" />
    <link rel="stylesheet" href="/css/style.css"/>
    <link rel="stylesheet" href="/css/prism.css"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon-32x32.png"/>
    <link type="application/atom+xml" rel="alternate" href="https://rokulikeahurricane.io/feed.xml" title="Tale" />
</head>

<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/">
                <h2 class="nav-title">Roku Like A Hurricane</h2>
            </a>
            <ul>
                <li><a href="/about.html">About</a></li>
            </ul>
        </div>
    </nav>

    <main>
        <div class="post">
            <div class="post-info">
                <span>Written by</span>
                    Brian
                <br>
                <span>on&nbsp;</span><time datetime="2018-12-18 12:00:00 +0000" class="catalogue-time">December 18, 2018</time>
            </div>

            <h1 class="post-title">Component initialization order</h1>
            <div class="post-line"></div>


            <h4>Category: <a href="categories/patterns.html">Patterns</a></h4>

            <div><p>Roku's documenation contains <a href="https://sdkdocs.roku.com/display/sdkdoc/Component+Initialization+Order">a good article</a> about component initialization order. Specifically, it states:</p>

<blockquote>
  <p>Instances of components defined in an XML file follow a well-defined initialization order when they are created.</p>
  
  <ul>
  <li>The <code>&lt;children&gt;</code> element nodes defined in XML markup are created, and their fields are set to their initial values, either to a default value, or to the value specified in the XML markup.</li>
  <li>The <code>&lt;interface&gt;</code> element fields of the XML component are created, and their initial values are set, either to a default value, or to the value specified by the value attribute.</li>
  <li>The <code>&lt;script&gt;</code> element <code>init()</code> function is called, and all initializations contained in the function are performed.</li>
  </ul>
</blockquote>

<p>While that is very helpful, it leaves out some subtle bits and sometimes it can be hard to visualize, so let's do some experiments to better illustrate the order.</p>

<p>Consider the following component hierarchies:</p>

<pre><code>Parent &gt; ParentBase &gt; Group
Child &gt; ChildBase &gt; Group
</code></pre>

<p>Let's let the <code>ParentBase</code> component define a <code>Child</code> in its <code>&lt;children&gt;</code> markup:</p>

<pre class="  language-markup"><code class="  language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ParentBase<span class="token punctuation">"</span></span> <span class="token attr-name">extends</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Group<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/brightscript<span class="token punctuation">"</span></span> <span class="token attr-name">uri</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>pkg:/components/ParentBase.brs<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>children</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>childInParentBase<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>children</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>component</span><span class="token punctuation">&gt;</span></span></code></pre>

<p>And, let's imagine that the <code>Parent</code> component defines a <code>Child</code> component as part of its <code>&lt;children&gt;</code>:</p>

<pre class="  language-markup"><code class="  language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Parent<span class="token punctuation">"</span></span> <span class="token attr-name">extends</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ParentBase<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/brightscript<span class="token punctuation">"</span></span> <span class="token attr-name">uri</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>pkg:/components/Parent.brs<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>children</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>childFromParent<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>children</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>component</span><span class="token punctuation">&gt;</span></span>
</code></pre>

<p>Now consider another component that uses the <code>Parent</code> component and defines some additional children:</p>

<pre class="  language-markup"><code class="  language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>OtherComponent<span class="token punctuation">"</span></span> <span class="token attr-name">extends</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Group<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/brightscript<span class="token punctuation">"</span></span> <span class="token attr-name">uri</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>pkg:/components/OtherComponent.brs<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>children</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Parent</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>firstchild<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>secondchild<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>children</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>component</span><span class="token punctuation">&gt;</span></span>
</code></pre>

<p>If you run this code, you will see that the order of the <code>init</code> calls is actually:</p>

<pre><code>ChildBase for childInParentBase
Child for childInParentBase
ParentBase for parent
ChildBase for childFromParent
ChildBase for childFromParent
Parent for parent
ChildBase for firstChild
Child for firstChild
ChildBase for secondChild
Child for secondChild
</code></pre>

<p>So if we wanted to write a more complete order of initialization, it might look like this:</p>

<ol>
<li>If the component extends another component, the base component (including all children) will be initialized first</li>
<li>Initialize nodes defined in <code>&lt;children&gt;</code></li>
<li>Call component's <code>init()</code> method</li>
<li>Field values are available for reading</li>
<li>Children added via markup are initialized</li>
</ol>

<p>Understanding the order is helpful, but understanding the implications is also very important. Consider these perhaps subtle implications:</p>

<h3>Non-default field values are not available in <code>init()</code></h3>

<p>Consider this <code>init()</code> code:</p>

<pre class="  language-vbnet"><code class="  language-vbnet"><span class="token keyword">sub</span> init<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ?<span class="token string">"My id is: "</span> <span class="token operator">+</span> m.top.id
<span class="token keyword">end</span> <span class="token keyword">sub</span></code></pre>

<p>Assuming the <code>id</code> property was set in markup, you might be surprised to see the output of this is:</p>

<pre><code>My id is:
</code></pre>

<p>At the time that <code>init()</code> is called, any non-defaulf field values are not yet set, so <code>m.top.id</code> has no value.</p>

<p>Similarly, any values you set on <code>m.top</code> in <code>init()</code> could be overwritten when initialization is complete:</p>

<pre class="  language-vbnet"><code class="  language-vbnet"><span class="token keyword">sub</span> init<span class="token punctuation">(</span><span class="token punctuation">)</span>
    m.top.id <span class="token operator">=</span> <span class="token string">"set_in_init"</span>
    ?<span class="token string">"My id is: "</span> <span class="token operator">+</span> m.top.id
<span class="token keyword">end</span> <span class="token keyword">sub</span>

<span class="token keyword">function</span> onKeyEvent<span class="token punctuation">(</span>key<span class="token punctuation">,</span> press<span class="token punctuation">)</span>
    ?<span class="token string">"My id is now: "</span> <span class="token operator">+</span> m.top.id
    <span class="token keyword">return</span> <span class="token keyword">true</span>
<span class="token keyword">end</span> <span class="token keyword">function</span>
</code></pre>

<p>Prints:</p>

<pre><code>My id is: set_in_init
My id is now: parent
</code></pre>

<h3>Cannot <code>setFocus()</code> from <code>init()</code></h3>

<p>The Roku docs say:</p>

<blockquote>
  <p>For nodes that are defined in the <code>&lt;children&gt;</code> XML markup of the component file, the parent node is set after the node is created, and <code>init()</code> is called.</p>
</blockquote>

<p>What that means is that the children created in a component are not yet valid targets for focus while <code>init()</code> is running. The children are not parented (added to the Scene Graph tree) until after <code>init()</code> is complete and calls to <code>setFocus()</code> require that the node being focused is in the Scene Graph tree.</p>

<p>(It is usually not a good idea to set the focus during object creation anyway, and a better approach is to set up an observer on <code>focusedChild</code> so that your component is aware when something is trying to set focus on it and handle focus at that time.)</p>
</div>
        </div>

        <div class="pagination">

                <a href="/divisible_by_3.html" class="right arrow">&#8594;</a>
            <a href="#" class="top">Top</a>
        </div>
    </main>

    <footer>
        <span>
            &copy; <time datetime="2019-01-01 00:00:00 +0000">2019</time> Brian Dunnington.
        </span>
    </footer>

</body>
</html>
